# Auto Mail Pilot: Phase 1 技術振り返り (Post-Mortem)

Phase 1 (MVP実装) において直面した課題と、それを解決するための学びを整理しました。今後の追加開発や別プロジェクトの参考にしてください。

## 1. 直面した技術的課題と解決策

### A. Rust の非同期(Async)とブロッキング通信の競合
- **課題**: `#[tokio::main]` を使用しながら `reqwest::blocking` を呼び出したため、実行時にパニック（Runtime error）が発生しました。
- **解決策**: GUIフレームワーク（eframe）もブロッキングな性質を持つため、`main` 関数から `async` 和 `tokio` を削除し、純粋な同期処理に統一しました。
- **教訓**: GUIアプリでは、安易に `async` を導入せず、通信ライブラリもブロッキング版を使用するか、完全に非同期スレッドに分離してメッセージングを行う必要があります。

### B. Google Workspace (GWS) のセキュリティ制限
- **課題**: 組織アカウント (`nikko-m.com`) では、GASウェブアプリを「全員（Anonymous）」に公開する設定が管理者によって制限されていました。
- **解決策**:
    1. 管理コンソールから「ドライブの外部共有」および「GASの組織外公開」をオンに設定。
    2. GASエディタ上で手動での「初回権限承認」を実行。
- **教訓**: 企業ドメインのGASを外部ツールから叩く場合、管理コンソールのポリシー確認が最優先事項です。

### C. ユーザー入力 URL の堅牢性 (Robustness)
- **課題**: URLをコピー＆ペーストした際に、末尾に改行やスペース、あるいは `?action=...` のようなクエリ文字列が混入し、APIリクエストの構築でエラーが発生しました。
- **解決策**:
    - `.trim()` による空白削除を徹底。
    - `?` 以降の文字列を自動で切り捨ててベースURLを抽出するロジックをRust側に実装。
- **教訓**: ユーザー入力のURLは「壊れている」前提でフィルタリングを実装すべきです。

---

## 2. 次回 (Phase 2) へのヒント

### アカウント管理の自動化
`clasp` を使う場合、複数のGoogleアカウントを切り替えると `.clasp.json` が競合します。本番用（Info）と開発用（個人）でディレクトリを分けるか、環境変数で管理するとスムーズです。

### 承認プロセスの簡略化
GAS側で新しいサービス（Google Sheets APIなど）を追加した際、`clasp push` だけでは承認が完了しません。一度ブラウザでエディタを開き、ボタンを押して承認するプロセスを手順書に含める必要があります。

### エラーメッセージの親切化
今回は「builder error」のような技術的なエラーが出ましたが、ユーザーには「URLを確認してください」といった具体的アクションを提示する工夫が、サポートコストの削減に繋がります。

---

## 3. 成功のポイント
- **スモールスタート (MVP)**: 難しい認証（OAuth）を後回しにし、まずはウェブアプリURLによる疎通を優先したことで、組織の制限という最大の問題を早期に発見・解決できました。
- **クイックな環境切り替え**: 組織アカウントで詰まった際、即座に個人アカウントで「動作の正解」を確認したことで、原因が「コード」ではなく「権限」にあることを切り分けられました。
