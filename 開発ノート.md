# Auto Mail Pilot 開発ノート

## 概要

**Auto Mail Pilot**は、Rust + egui で作成したWindows向けメール送信自動化アプリです。
Google Apps Script (GAS) と連携し、宛先・テンプレート・署名をクラウド管理しながら、
ファイル名から宛先を自動判定する機能を持っています。

---

## 主な機能

### 1. ファイル名から宛先を自動選択
- ドロップしたファイル名を解析（例: `株式会社ABC_納品書_2024.pdf`）
- 全パーツを抽出して宛先マスターとマッチング
- 部分一致・完全一致の両方に対応
- マッチしたら自動でロック（誤送信防止）

### 2. 宛先ロック機能
- ファイル添付時に宛先を自動ロック
- ロック中は別の宛先を選択できない
- 赤色の警告表示で視覚的に確認
- 手動で解除可能

### 3. 送信前確認ダイアログ
- チェックボックスによる確認必須
- 宛先・添付ファイルの最終確認
- 誤送信を防ぐ二重チェック

### 4. 3宛先同時送信
- 1回の操作で最大3件の宛先に送信可能
- 各宛先に個別の本文・添付ファイルを設定
- タブ切り替えで管理

### 5. GAS連携によるクラウドデータ管理
- 宛先マスター
- テンプレート
- 署名
- 送信履歴

---

## 技術スタック

| 技術 | 用途 |
|------|------|
| Rust | メイン言語 |
| eframe/egui | GUI フレームワーク |
| reqwest | HTTP クライアント（GAS API通信） |
| serde | JSON シリアライズ |
| base64 | 添付ファイルのエンコード |
| Google Apps Script | バックエンドAPI |

---

## 苦労したポイント

### 1. egui のテキストカーソルが見えない問題

**問題**: 青い背景の入力欄で、テキストカーソルが見えない

**解決策**:
```rust
// カーソル色を青の対局色（オレンジ）に設定
ui.visuals_mut().text_cursor.stroke = egui::Stroke::new(
    2.0,
    egui::Color32::from_rgb(255, 180, 0)
);
```

**学び**: `cursor_color`という直接的なフィールドはなく、`text_cursor.stroke`を使う必要があった。

---

### 2. レイアウトが添付ファイルで崩れる問題

**問題**: ファイルを添付すると、画面全体のレイアウトが大きく変わり、送信ボタンが見切れる

**試行錯誤**:
1. `ScrollArea`で全体をラップ → 上部セクションが消える
2. 各セクションの高さを動的に → 計算が複雑

**最終解決策**:
```rust
// 上部セクションの高さを固定
let top_section_height = 120.0;
ui.horizontal(|ui| {
    ui.set_height(top_section_height);
    // 各カラムも高さを固定
    ui.set_height(top_section_height - 8.0);
});
```

**学び**: 固定高さ + 内部スクロールが最も安定したレイアウトになる。

---

### 3. カラムのリサイズ機能

**実装方法**:
```rust
// セパレーターをドラッグ可能にする
let resize_response = ui.add(
    egui::Separator::default().vertical().spacing(4.0)
);
if resize_response.dragged() {
    state.col_width = (state.col_width + resize_response.drag_delta().x)
        .max(100.0)
        .min(500.0);
}
if resize_response.hovered() {
    ui.ctx().set_cursor_icon(egui::CursorIcon::ResizeHorizontal);
}
```

**ポイント**: `drag_delta()`で移動量を取得し、min/maxで範囲制限。

---

### 4. Git マージコンフリクト

**状況**: リモートとローカルで同時に開発が進み、複数ファイルでコンフリクト発生

**対処**:
1. 各ファイルのコンフリクトマーカーを確認
2. 両方の変更を理解した上で手動マージ
3. 機能の重複がないか確認
4. ビルド確認後にコミット

**学び**: 定期的なpull/pushで大規模コンフリクトを防ぐ。

---

### 5. Windows でコンソールウィンドウを非表示

**問題**: GUIアプリなのに黒いコンソールウィンドウが表示される

**解決策**:
```rust
// main.rs の先頭に追加
#![windows_subsystem = "windows"]
```

---

### 6. 日本語フォントの表示

**問題**: デフォルトでは日本語が豆腐（□）になる

**解決策**:
```rust
// システムフォントを読み込む
let font_paths = [
    "C:\\Windows\\Fonts\\msgothic.ttc",
    "C:\\Windows\\Fonts\\msmincho.ttc",
];

for path in font_paths {
    if let Ok(font_data) = std::fs::read(path) {
        fonts.font_data.insert(
            "jp_font".to_owned(),
            egui::FontData::from_owned(font_data),
        );
        // 優先度を最高に設定
        fonts.families.get_mut(&egui::FontFamily::Proportional)
            .unwrap()
            .insert(0, "jp_font".to_owned());
        break;
    }
}
```

---

## 設計で気を付けたこと

### 1. 誤送信防止を最優先
- 宛先ロック機能
- 送信前確認ダイアログ
- 検証エラー表示

### 2. 状態管理の一元化
- `AppState`構造体に全状態を集約
- `Arc<Mutex<AppState>>`で安全に共有

### 3. ユーザビリティ
- ファイルドロップで宛先自動選択
- カラムリサイズ対応
- オレンジ色カーソルで視認性向上
- ロック状態を赤色で強調

### 4. レスポンシブなレイアウト
- 固定高さセクション + 内部スクロール
- 最小/最大幅の制限

---

## 今後の改善案

- [ ] ダークモード/ライトモード切り替え
- [ ] 送信履歴の検索機能
- [ ] テンプレート内変数のプレビュー
- [ ] 複数ファイル一括処理
- [ ] オフライン時のキュー機能

---

## まとめ

Rust + egui でデスクトップアプリを作る際のポイント:

1. **レイアウト**: 固定高さを積極的に使う
2. **視認性**: 背景色と対照的な色を選ぶ
3. **状態管理**: 1つの構造体に集約
4. **エラー処理**: ユーザーにわかりやすく表示
5. **UX**: 自動化できる部分は自動化（ファイル名解析など）

egui は学習コストが低く、クロスプラットフォーム対応も容易。
業務ツールの作成に最適なフレームワークです。

---

*開発期間: 2024年12月〜2025年1月*
*開発者: nikko*
