# メール自動送信アプリ 開発プラン

## プロジェクト概要
- **技術スタック**: Rust + egui + Google Apps Script (GAS)
- **データストア**: Googleスプレッドシート
- **目的**: テンプレートベースのメール送信を効率化

## AI Agent向け注意事項

1. **このファイルを常にコンテキストとして使用すること**
   - 開発履歴、実装済み機能、未決定事項を確認してから作業を開始する

2. **GAS変更時は必ずclaspでデプロイまで実行すること**
   ```bash
   cd gas
   clasp push --force
   clasp deploy -d "バージョン説明"
   ```
   - push だけでなく deploy まで必須
   - デプロイ後は新しいURLを `settings.json` と `src/models.rs` に反映

---

## フェーズ構成

```
Phase 1 (MVP)
├── Step 1.1: プロジェクト基盤構築
├── Step 1.2: モデル層実装
├── Step 1.3: API通信層実装
├── Step 1.4: UI基本実装
└── Step 1.5: GASデプロイ・結合テスト

Phase 2 (機能拡張)
├── Step 2.1: ファイルドロップ機能
├── Step 2.2: 変数置換機能
├── Step 2.3: 送信履歴・ログ機能
├── Step 2.4: エラーハンドリング強化
├── Step 2.5: UI/UX改善
├── Step 2.6: 複数宛先・個別文面対応
└── Step 2.7: PDF OCR宛先抽出機能
```

---

## Phase 1: MVP

### Step 1.1: プロジェクト基盤構築
**作成ファイル**: `Cargo.toml`, `src/main.rs`

依存クレート:
- eframe / egui: GUI
- serde / serde_json: JSON処理
- reqwest: HTTP通信
- base64: 添付ファイルエンコード
- thiserror: エラー処理

---

### Step 1.2: モデル層実装
**作成ファイル**: `src/models.rs`

| 構造体 | 用途 |
|--------|------|
| `Template` | テンプレート (id, name, subject, body) |
| `Attachment` | 添付ファイル (file_path, file_name, enabled, data, mime_type) |
| `MailDraft` | メール下書き (to, subject, body, attachments) |
| `AppState` | アプリ状態 (templates, selected_template_index, mail_draft, etc.) |

---

### Step 1.3: API通信層実装
**作成ファイル**: `src/api.rs`

| メソッド | 機能 |
|----------|------|
| `get_templates()` | GASからテンプレート一覧取得 |
| `save_template()` | テンプレート保存 |
| `send_mail()` | メール送信 (添付ファイルはBase64) |

---

### Step 1.4: UI基本実装
**作成ファイル**: `src/app.rs`, `src/ui/mod.rs`, `src/ui/template_panel.rs`, `src/ui/mail_panel.rs`

**レイアウト**:
- 左パネル (SidePanel): テンプレート選択・編集
- 右パネル (CentralPanel): メール編集・プレビュー・送信

---

### Step 1.5: GASデプロイ
**作成ファイル**: `gas/Code.gs`

1. Googleスプレッドシート作成（「テンプレート」シート）
2. Apps Script でコード配置
3. Webアプリとしてデプロイ → URLをRust側に設定

**重要: デプロイ時の設定**
- 「次のユーザーとして実行」: 自分
- 「アクセスできるユーザー」: **全員** （この設定を忘れるとアクセス拒否エラーになります）

---

## Phase 2: 機能拡張

| Step | 機能 | 修正ファイル |
|------|------|-------------|
| 2.1 | ファイルドロップ | `main.rs`, `app.rs` |
| 2.2 | 変数置換 `{{name}}` | 新規 `template_engine.rs` |
| 2.3 | 送信履歴表示 | `api.rs`, 新規 `history_panel.rs` |
| 2.4 | エラー処理・リトライ | `api.rs`, `app.rs` |
| 2.5 | UI/UX大幅改善 (タブ化・3カラム構成) | `app.rs`, `ui/settings_panel.rs` |
| 2.6 | 複数宛先・個別文面対応 | `models.rs`, `ui/mail_panel.rs`, `gas/Code.gs` |

---

## ファイル構成（実装時）

```
mail-sender/
├── Cargo.toml
├── src/
│   ├── main.rs           # エントリーポイント
│   ├── app.rs            # AppState, MailApp
│   ├── models.rs         # データ構造
│   ├── api.rs            # GAS通信
│   ├── template_engine.rs # 変数置換 (Phase 2)
│   └── ui/
│       ├── mod.rs
│       ├── template_panel.rs
│       └── mail_panel.rs
└── gas/
    └── Code.gs
```

---

## 注意点

- **CORS**: GASはCORS対応済み、エラー時もJSON返却必須
- **添付ファイル**: 15MB制限 (Base64後20MB程度)
- **日本語フォント**: egui起動時にシステムフォント設定必要
- **Windows**: パス区切りに `PathBuf` 使用推奨

---

## 検証方法

1. `cargo build` でコンパイル確認
2. GASエンドポイントにブラウザでアクセス → JSON確認
3. アプリ起動 → テンプレート取得・メール送信テスト
4. 実際にメールが届くことを確認

---

## 未決定事項・検討中

- [x] もっているGmailアカウントからの送信対応
    - [NOTE] GASデプロイ時に実行ユーザーとして認証を行うため、そのアカウントが送信元となります。
- [x] 複数宛先（最大3件）への対応
- [x] 客先ごとの個別文面編集機能
- [ ] PDF添付時のOCR宛先自動抽出（検討中：精度とパターンの定義が必要）
- [x] 改行を含むテンプレート保存の対応
- [x] 署名自動挿入機能
- [x] 宛先マスタ連携（宛先に紐づく件名・本文の自動呼び出し）
- [x] 宛先リスト（スプレッドシート）からの読み込み連携（CSVドロップでインポート可能）
- [x] GASエンドポイントURLの管理方法
    - [NOTE] `settings.json` で管理、設定画面から変更可能
- [ ] 複数宛先への一括送信機能の優先度
- [ ] テンプレート削除機能の確認ダイアログ
- [ ] オフライン時の動作（キャッシュ等）
- [x] ファイル名から宛先自動選定機能

---

## 開発履歴

### 2026-01-22: GAS接続改善 & ファイル名自動選定

**実装内容:**

1. **GAS接続テスト自動化**
   - 起動時に自動接続テスト実行
   - 成功時「接続成功！」、失敗時エラーメッセージ表示

2. **POSTリダイレクト問題の修正**
   - GASの302リダイレクト時にPOSTボディが失われる問題を修正
   - リダイレクト先にはGETでアクセスする方式に変更

3. **ファイル名から宛先自動選定機能の改善**
   - ファイルドロップ時に会社名を抽出（`_`, ` `, `(` 等で分割）
   - 宛先マスターから一致する宛先を自動選択
   - 選択時にステータスメッセージで通知
   - 正規化処理（スペース除去、大文字小文字無視）で精度向上

**変更ファイル:**
- `src/api.rs`: POSTリダイレクト処理追加
- `src/app.rs`: 起動時接続テスト追加
- `src/ui/mail_panel.rs`: 宛先自動選定の改善
- `src/models.rs`: GAS URL更新
- `settings.json`: 最新デプロイURL (@18)

**GASデプロイ:** バージョン @18 (v18 Auto Connect Test)

### 2026-01-22: 宛先自動選定のマッチング改善

**問題:**
- ファイル「日興金属株式会社_納品書_20...」をドロップしても宛先が自動選択されない

**原因:**
- マッチングロジックが `company` フィールドのみを検索していた
- 宛先データの `name` フィールドに会社名が含まれている場合にマッチしなかった

**修正内容:**
- `company` と `name` 両方のフィールドをチェックするように改善
- 結合した文字列（name + company）でもマッチ判定を追加
- より柔軟な部分一致検索を実装

**変更ファイル:**
- `src/ui/mail_panel.rs`: マッチングロジックを拡張（company, name, combined をチェック）

### 2026-01-22: スプレッドシート列の動的マッピング

**問題:**
- スプレッドシートの列順序やヘッダー名が異なると、データが正しく取得されない

**修正内容:**
- GASの`getRecipients()`関数をヘッダー行から動的にカラム位置を検出するように改善
- 「会社」「company」「氏名」「name」「メール」「email」等のキーワードで自動マッピング

**変更ファイル:**
- `gas/Code.gs`: 動的カラムマッピング機能を追加

**GASデプロイ:** バージョン @19 (v19 Dynamic column mapping)
